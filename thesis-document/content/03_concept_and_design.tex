\chapter{Concept and Design}
\label{cha:conceptanddesign}

This chapter outlines the key components of the implementation of environments in the MS.
The core components are users, environments, roles, and assets.
In essence the concept can be summarized as follows: users can be part of to multiple environments.
Environments hold Assets.
Users that are part of an environment can work on the assets that are stored in it.
What a user can do with an asset is determined by the roles that the user has in the
environment that the asset is stored in.
All other components that will be introduced will help to manage and enforce these relationships.

\section{Users}
\label{cha:conceptanddesign:users}
%NOTE: maybe change the sctructure of this paragraph a bit

Previously users in the MS represented a member of a single organization.
In order for users to be part of multiple organizations, they can't be tied to a single
organization.
As a part of the implementation of environments, users are now independent of
organizations,
they now represent individual people utilizing PROCEED.
A single person can have one or more users, but each user is intended for individual use.

To facilitate the exploration of the MS, without creating a user, we introduce the option
to use the MS as a guest.
Thus, we differentiate between authenticated users and guest users.
Guest users have a limited feature. 
Guest users can transition to being an authenticated users whilst retaining their
assets, to do this they will need to sign in with personal data.
% Creating a Guest user doesn't require any data from the person creating it.

All users have a personal environment \ref{cha:conceptanddesign:environments:personal}
in which they can create and manage assets freely.
Authenticated users can also be part of and create organization environments
\ref{cha:conceptanddesign:environments:organization},
where they can collaborate with other users.

\subsection{Guest User storage}

For storing guest user data, one could take one of two approaches:
storing the data in the user's browser or storing it in the MS's database, alongside the
data of authenticated users.
Storing the data locally has two great benefits: 
The MS doesn't have to store data of users who might never return and
the MS would become less susceptible to an attack where the attacker tries to use up as
much space as possible in the MS's storage solution.
However, this approach has one key downside, the MS would have to implement two storage
solutions and the frontend would need to switch accordingly between them.
This complexity would make it harder for developers to get an overview of the MS's
codebase and it also makes it harder to use assistance features of IDEs like go to
definition\footnote{\url{https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_definition}}.
The added complexity of storing guest user's data locally isn't worth the benefits, so we
decided to store a guest user's data in the MS's database and create an entry for him in
the Database like for all users, with the difference that a flag is set, to indicate that
he is a guest.
This way, all the same endpoints that authenticated users can call to interact with the MS
can also be called by guest users.
An important caveat is that now all relevant endpoints have to check whether the user 

\subsection{Development Users}

When developing the MS, it is not common for the developer to have all the necessary keys
configured in the environment variables, for the MS to be able to authenticate users with
Oauth2 \ref{cha:relatedwork:oauth} or send sign-in emails.
For this reason the MS implements two development users: johndoe and admin.
When the MS is in development mode, i.e. the environment variable \lstinline{NODE_ENV} is
set to \lstinline{development},
the sign-in page shows a new input field where you can enter the developments user's username.
Both users are stored as authenticated users in the MS's database and can be used to test
the MS during development.


%TODO: say what guests can do?

% NOTE: I think this goes in implementation
% \subsection{Accounts}
%
% Accounts represent a use's sign in method. 

\section{Folders}

Folders are nodes in a rooted tree structure with a name and a description.
Folders can contain other folders and assets.
At the moment writing, folders only support processes, but they could be extended to
support other types of assets like the ones described in \ref{cha:relatedwork:proceed-assets}.

Each environment will have a folder structure to store its processes.
The root folder is created when the environment is created.
Each root folder and all of its children are contained by one and only one environment \ref{cha:conceptanddesign:environments}.

Folders are intended to allow users to mirror the hierarchical structure of their
organization and of its projects.

% Since the root folder belongs to only one environment, and all folders are stored below
% one root folder, all folders belong to only one environment.
% Processes will then store a reference to the folder they're stored in.

% TODO: ask kai if I should explain rooted trees - would be nice to cookup a formal def


\section{Assets}

All assets within the MS \ref{cha:relatedwork:proceed-assets}
will be modified, so that each asset instance establishes a clear association with a single environment.
Processes will be contained within folders, explicitly indicating to what environment they
belong.
Other asset types will store a direct reference to their environment, without being
contained in a folder structure, this can be seen as a flat folder structure.

% The key principle is that every asset belongs to one and only one environment, and this
% association can be easily identified.

% All of the MS's assets will only change in one way, they will somehow linked to an
% environment and only one.
% For processes, they're contained in a folder, such that they clearly belong to one
% environment. for other assets, they will store a reference to the environment they belong
% to.
% The important part is that each asset belongs to exactly one environment, and this
% environment can be identified.

\section{Environments}
\label{cha:conceptanddesign:environments}

Conceptually environments are the data structure in which everything, other than users, is
stored.
Users aren't stored in environments as they can be a part of multiple environments, 
so they can't be contained in only one environment.
Instead, the MS stores memberships that specify that a user is part of an environment.
Everything else, assets and roles, belong to exactly one environment.

We distinguish between two types of environments: personal environments and organization
environments.

\subsection{Personal Environments}
\label{cha:conceptanddesign:environments:personal}

Personal environments are assigned to each user once they sign in. 
%NOTE: remove the part with owner
The user for which the environment is created, is the only member of this
environment, and is therefore called the owner.
No other users be a part of this environment.
%TODO: forward ref to folders
Personal environment only allow users to create and manage processes and folders,
other Features that the MS offers are disabled for personal environments and can only be
used in organization environments \ref{cha:conceptanddesign:environments:organization}.

\subsection{Organization Environments}
\label{cha:conceptanddesign:environments:organization}

Organization environments are intended to be used by organizations, thus they can have a
name, description and a logo.
Organization environments extend the feature set of personal environments, the enabled
resources \ref{cha:relatedwork:proceedroles:ms-resources-actions} for organization
environments can be determined when deploying a MS instance.

Organization environments can also have multiple Users that are part of it, these are
called members.


\subsection{Environment selection}

% TODO: finish this
Users will be able to 

\section{Roles}

Before the implementation of this thesis, roles in the MS
\ref{cha:relatedwork:proceedroles} were global,
meaning that their permissions applied to all assets in the MS.
With the introduction of the folder structure in organization environments, this no longer makes sense.
Folders allow organizations to mirror their hierarchical structure, but this wouldn't be
entirely useful if roles were still global.
For this reason, roles can now be associated to a folder.
Roles that are associated with a folder cascade down the
folder structure, i.e. a role associated to a folder will also apply to all of its children.
Roles that aren't associated to a folder will continue to apply to all assets in the environment.
As roles are meant to mirror a users position in an organization, they're only available
for organization environments.

% TODOFIG: show how roles cascade

If a user's role allows him to view assets and is associated to a folder, then the user
also has the permission to view all parent folders of the folder the role is associated to.
But this is only restricted to the parent folders, not the contents of the parent folders.
This allows users to navigate the folder structure until they reach the assets they're
allowed to view and manage.

% TODOFIG: show how user can view path to his folder

\subsection{Default roles}

For each organization environment two roles will be created, which cannot be deleted and
cannot be associated to a folder:

\begin{itemize}
  \item \lstinline{@admin}: This role has all permissions for all assets in the
    organization environment and it is first assigned to the user that creates the organization environment.
    Only users with the \lstinline{@admin} role can add new users to this role.
  \item \lstinline{@everyone}: The permissions in this role apply to for all the users
    that are part of the organization environment. The permissions in this role start out
    empty, but can be modified.
\end{itemize}

